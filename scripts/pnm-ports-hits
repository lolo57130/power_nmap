#!/bin/bash

if [ $# -lt 1 ]; then
	echo "Usage :";
	echo "  $0 dir : 	read from standard input and write resulting files in the 'dir' directory";
	echo "  $0 dir file : 	read from 'file' and write resulting files in the 'dir' directory";
	echo "Notes :";
	echo "- input (file or standard input) is a XML generated by nmap with -oX parameter";
	echo "- warning : files already in the directory will be overwritten";
	exit;
fi

ERROR=false;

if [ ! -d $1 ]; then
	echo "Error : '$1' is not a valid directory path";
	ERROR=true;
fi

if [ ! -f $2 ]; then
	echo "Error : '$2' is not a valid filename";
	ERROR=true;
fi

if $ERROR; then
	exit;
fi

# parameters mapping
OUTPUT_DIR=$1
INPUT_FILE=$2
RESOURCES_DIR=`dirname $0`"/res"

OUTPUT_FILE="$OUTPUT_DIR/ports-hits.tsv"

# resource files copy
for FILE in {"d3.min.js","ports-hits.html"}; do
	cp "$RESOURCES_DIR/$FILE" "$OUTPUT_DIR/$FILE";
done;

echo -e "Hosts	Port" > $OUTPUT_FILE
grep portid $INPUT_FILE | cut -d ' ' -f3 | cut -d '"' -f2 | sort -n | uniq -c | awk -F' ' '{ print $1 " " $2 }' | sed -e 's/ /\t/g' >> $OUTPUT_FILE

# à changer : ne pas ouvrir le navigateur (qui n'est pas forcément firefox, ni installé localement, ni graphique (cas d'une console d'administration d'un serveur web)).
# A la place, générer tous les fichiers nécessaires dans un dossier spécifié par l'utilisateur
# firefox Bar.html
