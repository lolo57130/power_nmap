#!/bin/bash

if [ $# -lt 1 ]; then
	echo "Usage :";
	echo "  $0 dir : 	read from standard input and write resulting files in the 'dir' directory";
	echo "  $0 dir file : 	read from 'file' and write resulting files in the 'dir' directory";
	echo "Notes :";
	echo "- input (file or standard input) is a XML generated by nmap with -oX parameter";
	echo "- warning : files already in the directory will be overwritten";
	exit;
fi

ERROR=false;

if [ ! -d $1 ]; then
	echo "Error : '$1' is not a valid directory path";
	ERROR=true;
fi

if [ ! -f $2 ]; then
	echo "Error : '$2' is not a valid filename";
	ERROR=true;
fi

if $ERROR; then
	exit;
fi

# parameters mapping
OUTPUT_DIR=$1
INPUT_FILE=$2
RESOURCES_DIR=`dirname $0`"/res"

OUTPUT_FILE="$OUTPUT_DIR/ports-map.tsv"

# resource files copy
for FILE in {"d3.min.js","ports-map.html"}; do
	cp "$RESOURCES_DIR/$FILE" "$OUTPUT_DIR/$FILE";
done;

produce_output()
{
	echo "Host	Port	Service"

	cat $INPUT_FILE | while read line; do
		echo $line | awk -F' ' '
			{
				split($1,bytes,".")
				printf("%03d%03d%03d%03d",bytes[1],bytes[2],bytes[3],bytes[4])
				print "	" $2 "	" $3
			}
		'
	done
}

produce_output > $OUTPUT_FILE

